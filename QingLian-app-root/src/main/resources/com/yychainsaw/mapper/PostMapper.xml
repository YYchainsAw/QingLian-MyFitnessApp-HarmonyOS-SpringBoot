<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.yychainsaw.mapper.PostMapper">

    <select id="selectPostFeed" resultType="com.yychainsaw.pojo.vo.PostVO">
        SELECT p.*, u.nickname, u.avatar_url
        FROM posts p
        LEFT JOIN users u ON p.user_id = u.user_id
        ORDER BY p.created_at DESC
    </select>

    <select id="selectActiveInfluencers" resultType="com.yychainsaw.pojo.vo.InfluencerVO">
        SELECT u.user_id, u.nickname, u.avatar_url,
        COUNT(p.post_id) as total_posts, SUM(p.likes_count) as total_likes
        FROM users u
        JOIN posts p ON u.user_id = p.user_id
        GROUP BY u.user_id, u.nickname, u.avatar_url
        HAVING COUNT(p.post_id) > 10
    </select>

    <select id="selectPotentialFriends" resultType="com.yychainsaw.pojo.vo.PotentialFriendVO">
        SELECT DISTINCT u.user_id, u.nickname, u.avatar_url, other_p.content as similar_content
        FROM users u
        JOIN posts other_p ON u.user_id = other_p.user_id
        JOIN (SELECT content FROM posts WHERE user_id = #{userId} LIMIT 5) my_posts
        ON other_p.content LIKE '%' || SUBSTRING(my_posts.content, 1, 5) || '%'
        WHERE u.user_id != #{userId}
        AND NOT EXISTS (SELECT 1 FROM friendships f WHERE (f.user_id = #{userId} AND f.friend_id = u.user_id) OR (f.user_id = u.user_id AND f.friend_id = #{userId}))
        LIMIT 10
    </select>

    <select id="selectGenderWeightStats" resultType="com.yychainsaw.pojo.vo.GenderStatVO">
        SELECT gender,
        FLOOR(weight_kg / 10) * 10 AS weight_range_start,
        COUNT(DISTINCT user_id) AS user_count,
        COUNT(post_id) * 1.0 / NULLIF(COUNT(DISTINCT user_id), 0) AS avg_posts
        FROM (SELECT u.user_id, u.gender, u.weight_kg, p.post_id FROM users u LEFT JOIN posts p ON u.user_id = p.user_id WHERE u.weight_kg IS NOT NULL) as sub
        GROUP BY gender, weight_range_start
        ORDER BY gender, weight_range_start
    </select>

</mapper>
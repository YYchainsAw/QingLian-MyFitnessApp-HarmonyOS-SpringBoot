<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>WebSocket 群聊/私聊测试</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <style>
        body { font-family: sans-serif; padding: 20px; }
        .container { display: flex; gap: 20px; flex-wrap: wrap; }
        .box { border: 1px solid #ccc; padding: 15px; width: 30%; min-width: 300px; }
        #log { height: 300px; overflow-y: scroll; background: #f0f0f0; border: 1px solid #999; padding: 5px; margin-top: 10px;}
        .input-group { margin-bottom: 10px; }
        label { display: inline-block; width: 80px; font-weight: bold; font-size: 0.9em;}
        input[type="text"] { width: 180px; }
        button { cursor: pointer; padding: 5px 10px; }
        hr { margin: 15px 0; border: 0; border-top: 1px solid #eee; }
    </style>
</head>
<body>

<h2>WebSocket 消息测试台</h2>

<div class="input-group">
    <label style="width: auto;">Token:</label>
    <input type="text" id="token" placeholder="Bearer eyJhbGci..." style="width: 400px;">
    <button onclick="connect()">连接 WebSocket</button>
    <button onclick="disconnect()">断开</button>
    <span id="status" style="color: red; margin-left: 10px;">未连接</span>
</div>

<div class="container">
    <!-- 1. 群组管理区域 -->
    <div class="box" style="background-color: #f9fdf9;">
        <h3>1. 群组管理</h3>
        <div class="input-group">
            <label>群名称:</label>
            <input type="text" id="newGroupName" placeholder="输入群名称">
        </div>
        <div class="input-group">
            <label>群公告:</label>
            <input type="text" id="newGroupNotice" placeholder="输入群公告">
        </div>
        <button onclick="createGroup()">创建群组 (POST)</button>

        <hr/>
        <h4>邀请成员</h4>
        <div class="input-group">
            <label>群组ID:</label>
            <input type="text" id="inviteGroupId" placeholder="输入群ID">
        </div>
        <div class="input-group">
            <label>成员ID:</label>
            <input type="text" id="inviteUserId" placeholder="输入对方的 User UUID">
        </div>
        <button onclick="inviteMember()">添加成员 (POST)</button>
    </div>

    <!-- 2. 发送消息区域 -->
    <div class="box">
        <h3>2. 发送消息</h3>
        <div class="input-group">
            <label>类型:</label>
            <select id="msgType" onchange="toggleInputs()">
                <option value="private">私聊</option>
                <option value="group">群聊</option>
            </select>
        </div>
        <div class="input-group" id="receiverInput">
            <label>接收人ID:</label>
            <input type="text" id="receiverId" placeholder="User UUID">
        </div>
        <div class="input-group" id="groupInput" style="display:none;">
            <label>群组ID:</label>
            <input type="text" id="groupId" placeholder="Group ID (Long)">
        </div>
        <div class="input-group">
            <label>内容:</label>
            <input type="text" id="content" placeholder="Hello World">
        </div>
        <button onclick="sendMessage()">发送消息 (POST)</button>
    </div>

    <!-- 3. 功能测试区域 -->
    <div class="box">
        <h3>3. 功能测试</h3>
        <div class="input-group">
            <button onclick="getUnreadCount()">获取总未读数 (GET)</button>
            <span id="unreadCountDisplay" style="font-weight: bold; color: blue; margin-left: 10px;">-</span>
        </div>
        <hr/>
        <div class="input-group">
            <label>群ID:</label> <input type="text" id="readGroupId" style="width: 60px;">
            <label style="width: 50px;">MsgID:</label> <input type="text" id="readMsgId" style="width: 60px;">
            <button onclick="markGroupRead()">标记已读</button>
        </div>
        <hr/>
        <div class="input-group">
            <label>订阅群:</label>
            <input type="text" id="subGroupId" placeholder="Group ID">
            <button onclick="subscribeGroup()">订阅群消息</button>
        </div>
    </div>
</div>

<h3>消息日志</h3>
<div id="log"></div>

<script>
    var stompClient = null;
    var baseUrl = 'http://localhost:8080'; // 后端地址

    function log(msg) {
        var p = document.createElement('p');
        p.style.margin = '2px 0';
        p.innerText = new Date().toLocaleTimeString() + ' - ' + msg;
        document.getElementById('log').prepend(p);
    }

    function toggleInputs() {
        var type = document.getElementById('msgType').value;
        document.getElementById('receiverInput').style.display = type === 'private' ? 'block' : 'none';
        document.getElementById('groupInput').style.display = type === 'group' ? 'block' : 'none';
    }

    function getToken() {
        var token = document.getElementById('token').value;
        if (!token) { alert("请输入 Token"); return null; }
        return token;
    }

    // === WebSocket 连接 ===
    function connect() {
        var token = getToken();
        if (!token) return;

        var socket = new SockJS(baseUrl + '/ws');
        stompClient = Stomp.over(socket);

        stompClient.connect({'Authorization': token}, function (frame) {
            document.getElementById('status').innerText = '已连接';
            document.getElementById('status').style.color = 'green';
            log('Connected: ' + frame);

            // 默认订阅私聊频道
            stompClient.subscribe('/user/queue/messages', function (message) {
                log('收到私信: ' + message.body);
            });

        }, function(error) {
            log('连接失败: ' + error);
            document.getElementById('status').innerText = '连接断开';
            document.getElementById('status').style.color = 'red';
        });
    }

    function disconnect() {
        if (stompClient !== null) {
            stompClient.disconnect();
        }
        document.getElementById('status').innerText = '未连接';
        document.getElementById('status').style.color = 'red';
        log("Disconnected");
    }

    function subscribeGroup() {
        var gid = document.getElementById('subGroupId').value;
        if(!gid) return;
        if(!stompClient || !stompClient.connected) { alert("请先连接 WebSocket"); return; }

        stompClient.subscribe('/topic/group.' + gid, function (message) {
            log('收到群['+gid+']消息: ' + message.body);
        });
        log('已订阅群: ' + gid);
    }

    // === HTTP 接口调用 ===

    // 1. 创建群组
    function createGroup() {
        var token = getToken(); if(!token) return;
        var name = document.getElementById('newGroupName').value;
        var notice = document.getElementById('newGroupNotice').value;

        if (!name) { alert("请输入群名称"); return; }

        fetch(baseUrl + '/groups', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': token },
            body: JSON.stringify({ name: name, notice: notice, avatarUrl: "https://example.com/default.png" })
        })
            .then(res => res.json())
            .then(data => {
                log('创建群组结果: ' + JSON.stringify(data));
                if (data.data && data.data.groupId) {
                    var gid = data.data.groupId;
                    // 自动填入所有相关输入框，方便测试
                    document.getElementById('groupId').value = gid;
                    document.getElementById('subGroupId').value = gid;
                    document.getElementById('readGroupId').value = gid;
                    document.getElementById('inviteGroupId').value = gid;
                    log('>>> 群组创建成功！ID: ' + gid + ' 已自动填入输入框');
                }
            })
            .catch(err => log('请求失败: ' + err));
    }

    // 2. 邀请成员
    function inviteMember() {
        var token = getToken(); if(!token) return;
        var gid = document.getElementById('inviteGroupId').value.trim(); // 去除空格
        var uid = document.getElementById('inviteUserId').value.trim(); // 去除空格

        if (!gid || !uid) { alert("请填写群ID和成员ID"); return; }

        // 打印一下 URL 确认是否正确
        var url = `${baseUrl}/groups/${gid}/members?userId=${uid}`;
        log('正在请求: ' + url);

        fetch(url, {
            method: 'POST',
            headers: { 'Authorization': token }
        })
            .then(res => {
                // 如果状态码不是 200-299，抛出错误以便 catch 捕获
                if (!res.ok) {
                    throw new Error(`HTTP error! status: ${res.status}`);
                }
                return res.json();
            })
            .then(data => {
                log('添加成员结果: ' + JSON.stringify(data));
            })
            .catch(err => log('请求失败: ' + err));
    }


    // 3. 发送消息
    function sendMessage() {
        var token = getToken(); if(!token) return;
        var type = document.getElementById('msgType').value;
        var content = document.getElementById('content').value;

        var data = { content: content };
        if (type === 'private') {
            data.receiverId = document.getElementById('receiverId').value;
        } else {
            data.groupId = document.getElementById('groupId').value;
        }

        fetch(baseUrl + '/messages', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': token },
            body: JSON.stringify(data)
        })
            .then(response => response.json())
            .then(data => {
                log('发送结果: ' + JSON.stringify(data));
            });
    }

    // 4. 获取未读数
    function getUnreadCount() {
        var token = getToken(); if(!token) return;
        fetch(baseUrl + '/messages/unread/count', {
            method: 'GET',
            headers: { 'Authorization': token }
        })
            .then(res => res.json())
            .then(data => {
                document.getElementById('unreadCountDisplay').innerText = data.data;
                log('当前未读数: ' + data.data);
            });
    }

    // 5. 标记群已读
    function markGroupRead() {
        var token = getToken(); if(!token) return;
        var gid = document.getElementById('readGroupId').value;
        var mid = document.getElementById('readMsgId').value;

        fetch(`${baseUrl}/messages/group/read?groupId=${gid}&lastMsgId=${mid}`, {
            method: 'PUT',
            headers: { 'Authorization': token }
        })
            .then(res => res.json())
            .then(data => {
                log('标记已读结果: ' + JSON.stringify(data));
            });
    }
</script>

</body>
</html>
